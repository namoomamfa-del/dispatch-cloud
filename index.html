<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>배차관리</title>
    
    <!-- 1. 스타일 및 아이콘 (Tailwind CSS, FontAwesome) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 폰트 변경: 네이버 나눔스퀘어 -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">

    <style>
        /* 폰트 적용: NanumSquare */
        body { font-family: 'NanumSquare', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* 로딩 스피너 */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        /* 테이블 스타일 */
        .stats-table th, .stats-table td { white-space: nowrap; padding: 8px 12px; }
        .stats-table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        
        /* 캘린더 내부 텍스트 굵기 보정 */
        .cal-text-bold { font-weight: 800; }
    </style>

    <!-- 2. React 및 Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.6/babel.min.js"></script>

    <!-- 3. Firebase Compat 라이브러리 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 4. 한국 음력 변환 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/korean-lunar-calendar/dist/korean-lunar-calendar.min.js"></script>

    <!-- 5. 엑셀 변환 라이브러리 (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- [설정] Firebase 설정 (본인의 설정으로 교체하세요) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgdSAh6RLdKnVuvUSVT9tIKrGvLr9ajys",
            authDomain: "carainge-59142.firebaseapp.com",
            projectId: "carainge-59142",
            storageBucket: "carainge-59142.firebasestorage.app",
            messagingSenderId: "513172363375",
            appId: "1:513172363375:web:e053e2241c5adf950a959a",
            measurementId: "G-MTPB3SG23N"
        };

        const APP_ID = 'vFinal_React_Dispatch_v1';

        // --- Firebase 초기화 ---
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase 초기화 실패. 설정을 확인하세요.", e);
            }
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Lucide 아이콘 대체 (FontAwesome 매핑) ---
        const Icons = {
            Cloud: ({className}) => <i className={`fa-solid fa-cloud ${className}`} />,
            AccessibleBus: ({className}) => (
                <div className={`relative flex items-center justify-center ${className}`}>
                    <i className="fa-solid fa-bus text-[24px]"></i>
                    <i className="fa-brands fa-accessible-icon absolute text-white text-[11px] mt-[4px]"></i>
                </div>
            ),
            RotateCcw: ({className}) => <i className={`fa-solid fa-rotate-left ${className}`} />,
            PieChart: ({className}) => <i className={`fa-solid fa-chart-pie ${className}`} />,
            RotateCw: ({className}) => <i className={`fa-solid fa-rotate-right ${className}`} />,
            Maximize: ({className}) => <i className={`fa-solid fa-expand ${className}`} />,
            ChevronLeft: ({className}) => <i className={`fa-solid fa-chevron-left ${className}`} />,
            ChevronRight: ({className}) => <i className={`fa-solid fa-chevron-right ${className}`} />,
            Plus: ({className}) => <i className={`fa-solid fa-plus ${className}`} />,
            Trash2: ({className}) => <i className={`fa-solid fa-trash-can ${className}`} />,
            ChevronUp: ({className}) => <i className={`fa-solid fa-chevron-up ${className}`} />,
            ChevronDown: ({className}) => <i className={`fa-solid fa-chevron-down ${className}`} />,
            Bus: ({className}) => <i className={`fa-solid fa-bus ${className}`} />,
            BusFront: ({className}) => <i className={`fa-solid fa-van-shuttle ${className}`} />,
            UserCheck: ({className}) => <i className={`fa-solid fa-user-check ${className}`} />,
            Receipt: ({className}) => <i className={`fa-solid fa-receipt ${className}`} />,
            X: ({className}) => <i className={`fa-solid fa-xmark ${className}`} />,
            Link: ({className}) => <i className={`fa-solid fa-link ${className}`} />,
            ArrowLeft: ({className}) => <i className={`fa-solid fa-arrow-left ${className}`} />,
            Calendar: ({className}) => <i className={`fa-regular fa-calendar ${className}`} />,
            Settings: ({className}) => <i className={`fa-solid fa-gear ${className}`} />,
            Search: ({className}) => <i className={`fa-solid fa-magnifying-glass ${className}`} />,
            ChevronDownCircle: ({className}) => <i className={`fa-solid fa-circle-chevron-down ${className}`} />,
            ChevronUpCircle: ({className}) => <i className={`fa-solid fa-circle-chevron-up ${className}`} />,
            UserX: ({className}) => <i className={`fa-solid fa-user-xmark ${className}`} />,
            Database: ({className}) => <i className={`fa-solid fa-database ${className}`} />,
            Download: ({className}) => <i className={`fa-solid fa-download ${className}`} />,
            Upload: ({className}) => <i className={`fa-solid fa-upload ${className}`} />,
            FileExcel: ({className}) => <i className={`fa-solid fa-file-excel ${className}`} />,
            Table: ({className}) => <i className={`fa-solid fa-table ${className}`} />,
            Clock: ({className}) => <i className={`fa-regular fa-clock ${className}`} />,
            Money: ({className}) => <i className={`fa-solid fa-won-sign ${className}`} />,
            Palette: ({className}) => <i className={`fa-solid fa-palette ${className}`} />
        };

        // --- 유틸리티 함수 ---
        const getTodayStr = () => {
            const now = new Date();
            const kstTime = now.getTime() + (9 * 60 * 60 * 1000);
            return new Date(kstTime).toISOString().split('T')[0];
        };

        const getTodayDate = () => {
            const [y, m, d] = getTodayStr().split('-');
            return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
        };

        const SOLAR_HOLIDAYS = {
            "01-01": "신정", "03-01": "삼일절", "05-05": "어린이날", "06-06": "현충일",
            "08-15": "광복절", "10-03": "개천절", "10-09": "한글날", "12-25": "성탄절"
        };

        const generateHolidays = () => {
            const calendar = new KoreanLunarCalendar();
            const holidays = {};

            const addSubstitute = (dateStr, name, originalDateObj) => {
                const day = originalDateObj.getDay(); 
                let subDate = new Date(originalDateObj);
                let needed = false;

                if (["설날 연휴", "설날", "추석 연휴", "추석"].includes(name)) {
                    if (day === 0) needed = true;
                } else if (name === "어린이날" || name === "삼일절" || name === "광복절" || name === "개천절" || name === "한글날" || name === "성탄절" || name === "부처님오신날") {
                    if (day === 0 || day === 6) needed = true;
                }

                if (needed) {
                    subDate.setDate(subDate.getDate() + 1);
                    if (day === 6) subDate.setDate(subDate.getDate() + 1); 
                    while (holidays[subDate.toISOString().split('T')[0]]) {
                        subDate.setDate(subDate.getDate() + 1);
                    }
                    holidays[subDate.toISOString().split('T')[0]] = "대체공휴일";
                }
            };

            for (let year = 2024; year <= 2054; year++) {
                Object.entries(SOLAR_HOLIDAYS).forEach(([md, name]) => {
                    const dateStr = `${year}-${md}`;
                    holidays[dateStr] = name;
                    if (name !== "신정" && name !== "현충일") {
                        addSubstitute(dateStr, name, new Date(year, parseInt(md.split('-')[0])-1, parseInt(md.split('-')[1])));
                    }
                });

                const lunarEvents = [{ m: 1, d: 1, name: "설날" }, { m: 4, d: 8, name: "부처님오신날" }, { m: 8, d: 15, name: "추석" }];
                lunarEvents.forEach(evt => {
                    calendar.setLunarDate(year, evt.m, evt.d, false);
                    const solar = calendar.getSolarCalendar();
                    const dateStr = `${solar.year}-${String(solar.month).padStart(2,'0')}-${String(solar.day).padStart(2,'0')}`;
                    const dateObj = new Date(solar.year, solar.month - 1, solar.day);

                    if (evt.name === "설날" || evt.name === "추석") {
                        const prevDate = new Date(dateObj); prevDate.setDate(dateObj.getDate() - 1);
                        const nextDate = new Date(dateObj); nextDate.setDate(dateObj.getDate() + 1);
                        holidays[prevDate.toISOString().split('T')[0]] = `${evt.name} 연휴`;
                        holidays[dateStr] = evt.name;
                        holidays[nextDate.toISOString().split('T')[0]] = `${evt.name} 연휴`;

                        [prevDate, dateObj, nextDate].forEach(d => {
                            if (d.getDay() === 0) {
                                let sub = new Date(nextDate); sub.setDate(sub.getDate() + 1);
                                while(holidays[sub.toISOString().split('T')[0]]) sub.setDate(sub.getDate() + 1);
                                holidays[sub.toISOString().split('T')[0]] = "대체공휴일";
                            }
                        });
                    } else {
                        holidays[dateStr] = evt.name;
                        addSubstitute(dateStr, evt.name, dateObj);
                    }
                });
            }
            return holidays;
        };

        const GENERATED_HOLIDAYS = generateHolidays();
        const getHolidayName = (dateStr) => GENERATED_HOLIDAYS[dateStr] || null;
        const isPublicHoliday = (dateStr) => {
            if (!dateStr) return false;
            const dayOfWeek = new Date(dateStr).getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) return true;
            return !!GENERATED_HOLIDAYS[dateStr];
        };

        const calculateWorkHours = (start, end, isDateHoliday, isForceHoliday) => {
            if (!start || !end) return { work: 0, extra: 0, adjusted: 0, valid: false };
            const [sH, sM] = start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            let startMin = sH * 60 + sM;
            let endMin = eH * 60 + eM;
            if (endMin < startMin) endMin += 24 * 60;
            let diffMin = endMin - startMin;
            let totalHours = diffMin / 60;
            const work = Math.max(0, totalHours - 1); 
            let extra = 0, adjusted = 0;
            if (isDateHoliday || isForceHoliday) {
                const regularHolidayWork = Math.min(8, work);
                const overtimeHolidayWork = Math.max(0, work - 8);
                adjusted = (regularHolidayWork * 1.5) + (overtimeHolidayWork * 2.0);
                extra = overtimeHolidayWork; 
            } else {
                const overtimeWeekday = Math.max(0, work - 8);
                adjusted = overtimeWeekday * 1.5;
                extra = overtimeWeekday;
            }
            return { work: parseFloat(work.toFixed(1)), extra: parseFloat(extra.toFixed(1)), adjusted: parseFloat(adjusted.toFixed(1)), valid: true };
        };

        const calculatePay = (info) => {
            if (info.customPay) return parseInt(info.customPay) || 0;
            const type = info.operationType || '공공예약';
            const duration = info.duration;
            if (duration === 'seoul' || duration === 'etc') return 0;
            if (type !== '공공예약') return 0;
            if (duration <= 1) return 12500;
            return 35000 * duration;
        };

        const DEFAULT_DRIVERS = ["박기준", "변석현", "이명순", "김탁", "한상훈", "문인식", "황덕일", "강철규", "이상헌"];
        const DEFAULT_VEHICLES = [
            { id: 'B1', name: '1호차', plate: '4921', type: 'BUS', capacity: 2 },
            { id: 'B2', name: '2호차', plate: '4922', type: 'BUS', capacity: 2 },
            { id: 'B3', name: '3호차', plate: '1557', type: 'BUS', capacity: 2 },
            { id: 'S11', name: '11호차', plate: '7711', type: 'SOLATI', capacity: 1 },
            { id: 'S12', name: '12호차', plate: '7712', type: 'SOLATI', capacity: 1 },
            { id: 'S13', name: '13호차', plate: '7713', type: 'SOLATI', capacity: 1 },
            { id: 'S14', name: '14호차', plate: '7714', type: 'SOLATI', capacity: 1 }
        ];

        // --- 컴포넌트 ---
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const AutoSaveInput = ({ value, onSave, className, placeholder, type = "text", ...props }) => {
            const [localValue, setLocalValue] = useState(value || "");
            useEffect(() => { setLocalValue(value || ""); }, [value]);
            const handleChange = (e) => { setLocalValue(e.target.value); };
            const handleBlur = () => { if (localValue !== (value || "")) { onSave(localValue); } };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.target.blur(); } }
            return <input type={type} className={className} placeholder={placeholder} value={localValue} onChange={handleChange} onBlur={handleBlur} onKeyDown={handleKeyDown} {...props} />;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedDateStr, setSelectedDateStr] = useState(getTodayStr());
            const [viewDate, setViewDate] = useState(getTodayDate());
            
            const [driverNames, setDriverNames] = useState([]);
            const [vehiclesList, setVehiclesList] = useState([]);
            const [scheduleData, setScheduleData] = useState({});
            const [modal, setModal] = useState({ type: null, data: null });
            const [autoLinked, setAutoLinked] = useState(false);
            const [isCalendarExpanded, setIsCalendarExpanded] = useState(false); 
            const [expandedStatsDriver, setExpandedStatsDriver] = useState(null);
            
            // 정산 모드 (monthly, yearly) 및 상태
            const [statsMode, setStatsMode] = useState('monthly');
            const [statsYear, setStatsYear] = useState(new Date().getFullYear());
            const [statsMonth, setStatsMonth] = useState(new Date().getMonth());
            const [yearlyViewType, setYearlyViewType] = useState('money'); 

            const [leftPanelWidth, setLeftPanelWidth] = useState(() => {
                // PC 화면에서 초기 65%로 설정
                return window.innerWidth >= 1024 ? window.innerWidth * 0.65 : 380;
            });
            const isDragging = useRef(false);
            const [isDesktop, setIsDesktop] = useState(window.innerWidth >= 1024);

            useEffect(() => {
                const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const handleMouseDown = () => { isDragging.current = true; document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none'; };
            const handleMouseUp = () => { isDragging.current = false; document.body.style.cursor = 'default'; document.body.style.userSelect = 'auto'; };
            const handleMouseMove = useCallback((e) => { 
                if (!isDragging.current) return; 
                const maxWidth = window.innerWidth * 0.8;
                const newWidth = Math.max(280, Math.min(maxWidth, e.clientX - 24)); 
                setLeftPanelWidth(newWidth); 
            }, []);

            useEffect(() => { window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); }; }, [handleMouseMove]);

            useEffect(() => {
                const initAuth = async () => { if (!auth.currentUser) await auth.signInAnonymously(); };
                initAuth();
                const unsubscribeAuth = auth.onAuthStateChanged((u) => { if (u) setUser(u); });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubMaster = db.doc(`artifacts/${APP_ID}/public/data/settings/master`).onSnapshot((docSnap) => {
                    if (docSnap.exists) { const data = docSnap.data(); setDriverNames(data.driverNames || []); setVehiclesList(data.vehiclesList || []); } 
                    else { db.doc(`artifacts/${APP_ID}/public/data/settings/master`).set({ driverNames: DEFAULT_DRIVERS, vehiclesList: DEFAULT_VEHICLES }); }
                    setIsLoading(false);
                });
                const unsubCalendar = db.collection(`artifacts/${APP_ID}/public/data/calendar`).onSnapshot((snapshot) => {
                    const newSchedule = {}; snapshot.forEach((doc) => { newSchedule[doc.id] = doc.data(); }); setScheduleData(newSchedule);
                });
                return () => { unsubMaster(); unsubCalendar(); };
            }, [user]);

            const moveMonth = (offset) => { const newDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + offset, 1); setViewDate(newDate); };

            const changeStatsMonth = (offset) => {
                let newMonth = statsMonth + offset;
                let newYear = statsYear;
                if (newMonth > 11) { newMonth = 0; newYear++; }
                else if (newMonth < 0) { newMonth = 11; newYear--; }
                setStatsMonth(newMonth);
                setStatsYear(newYear);
            };

            const handleBackup = () => {
                const data = { version: 1, timestamp: new Date().toISOString(), master: { driverNames, vehiclesList }, calendar: scheduleData };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `dispatch_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
            };

            const handleRestore = async (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!confirm("현재 데이터를 덮어쓰고 백업 데이터를 복원하시겠습니까?")) return;
                        setIsLoading(true);
                        if (data.master) await db.doc(`artifacts/${APP_ID}/public/data/settings/master`).set(data.master);
                        if (data.calendar) { await Promise.all(Object.entries(data.calendar).map(([date, dayData]) => db.collection(`artifacts/${APP_ID}/public/data/calendar`).doc(date).set(dayData))); }
                        alert("데이터 복원 완료"); setModal({ type: null });
                    } catch (err) { alert("오류 발생"); console.error(err); } finally { setIsLoading(false); }
                };
                reader.readAsText(file);
            };

            const resetAll = async () => {
                if(confirm("모든 데이터를 초기화하시겠습니까?")) {
                    await db.doc(`artifacts/${APP_ID}/public/data/settings/master`).set({ driverNames: DEFAULT_DRIVERS, vehiclesList: DEFAULT_VEHICLES });
                    alert("운전자 명단과 차량 목록이 초기화되었습니다.");
                }
            };

            const getPrevDateStr = (dateStr, days) => {
                const d = new Date(dateStr);
                d.setDate(d.getDate() - days);
                return d.toISOString().split('T')[0];
            };

            const calculateDispatchLogic = (dayData, drivers, vehicles, excludedDriverIds = new Set()) => {
                if (!dayData) return [];
                const currentRanks = dayData.driverRanks && dayData.driverRanks.length === drivers.length ? dayData.driverRanks : drivers.map((_, i) => i + 1);
                
                let pool = drivers.map((nm, i) => ({ 
                    nm, id: i, 
                    active: dayData.driverStatus ? dayData.driverStatus[i] : true, 
                    rank: currentRanks[i] 
                })).filter(d => d.active && !excludedDriverIds.has(d.id)).sort((a, b) => a.rank - b.rank);
                
                const resIds = Object.keys(dayData.reserved || {});
                const sortedV = vehicles.filter(v => resIds.includes(v.id)).sort((a, b) => {
                    const infoA = dayData.reserved[a.id];
                    const infoB = dayData.reserved[b.id];
                    if (a.type !== b.type) { return a.type === 'BUS' ? -1 : 1; }
                    if (infoA.duration !== infoB.duration) { return infoA.duration - infoB.duration; }
                    
                    if ((infoA.km || 0) !== (infoB.km || 0)) { return (infoA.km || 0) - (infoB.km || 0); }
                    if (a.type === 'BUS') {
                        const getBusRank = (name) => {
                            if (name.includes('3호')) return 1;
                            if (name.includes('1호')) return 2;
                            if (name.includes('2호')) return 3;
                            return 4; 
                        };
                        return getBusRank(a.name) - getBusRank(b.name);
                    }
                    return a.name.localeCompare(b.name);
                });

                const result = [];
                const manualAssignments = {}; 
                Object.entries(dayData.overrides || {}).forEach(([key, dId]) => { manualAssignments[key] = dId; pool = pool.filter(p => p.id !== dId); });

                sortedV.forEach(v => {
                    const info = dayData.reserved[v.id];
                    const slots = [];
                    
                    for(let i=0; i<v.capacity; i++) {
                        const key = `${v.id}_${i}`;
                        let autoDriver = null;

                        // 취소(isCancelled) 상태이거나, 운전원변경(isUnavailable) 상태이면 순번을 강제로 소모
                        // 단, 정상 상태라도 수동배정이 없으면 순번을 정상 소모함.
                        let shouldConsumeTurn = false;
                        if (info.isCancelled) shouldConsumeTurn = true;
                        else if (info.isUnavailable) shouldConsumeTurn = true;
                        else if (manualAssignments[key] === undefined) shouldConsumeTurn = true;

                        if (shouldConsumeTurn && pool.length > 0) {
                            autoDriver = pool.shift();
                        }

                        if (manualAssignments[key] !== undefined) {
                            const dId = manualAssignments[key];
                            const driverName = drivers[dId];
                            slots.push({ 
                                nm: driverName || '삭제됨', 
                                id: dId, 
                                type: 'manual', 
                                rank: currentRanks[dId],
                                consumedAutoDriverId: autoDriver ? autoDriver.id : undefined 
                            });
                        } else if (info.isUnavailable) {
                            // 수동배정 안된 상태에서 운전원변경이면 공석 (순번은 이미 소모됨)
                            slots.push(autoDriver ? { ...autoDriver, type: 'excluded', isExcluded: true } : null);
                        } else {
                            // 일반 (취소 포함) 자동 배정
                            slots.push(autoDriver ? { ...autoDriver, type: 'auto' } : null);
                        }
                    }
                    result.push({ vehicle: v, slots, info: dayData.reserved[v.id] });
                });
                return result;
            };

            const allScheduleWithRanks = useMemo(() => {
                const dates = Object.keys(scheduleData).sort();
                const n = driverNames.length;
                if (n === 0) return {};

                const processedSchedule = {};
                let lastDriverId = -1;
                let currentRanks = Array.from({length: n}, (_, i) => i + 1);

                dates.forEach(date => {
                    if (lastDriverId !== -1) {
                        const newRanks = Array(n).fill(0);
                        let startIdx = (lastDriverId + 1) % n;
                        let currentRank = 1;
                        for (let k = 0; k < n; k++) {
                            const targetIdx = (startIdx + k) % n;
                            newRanks[targetIdx] = currentRank++;
                        }
                        currentRanks = newRanks;
                    }

                    const rawDayData = scheduleData[date] || {};
                    const getPrevDate = (d, offset) => {
                        const dateObj = new Date(d);
                        dateObj.setDate(dateObj.getDate() - offset);
                        return dateObj.toISOString().split('T')[0];
                    };
                    const d1 = getPrevDate(date, 1);
                    const d2 = getPrevDate(date, 2);
                    const excludedIds = new Set();
                    if (processedSchedule[d1]) {
                         processedSchedule[d1].dispatchResult.forEach(r => {
                             if (r.info.duration >= 2 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && excludedIds.add(s.id));
                         });
                    }
                    if (processedSchedule[d2]) {
                         processedSchedule[d2].dispatchResult.forEach(r => {
                             if (r.info.duration >= 3 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && excludedIds.add(s.id));
                         });
                    }

                    // 당직 상태 병합
                    const ondutyStatus = rawDayData.ondutyStatus && rawDayData.ondutyStatus.length === n 
                        ? rawDayData.ondutyStatus 
                        : Array(n).fill(false);
                    const driverStatus = rawDayData.driverStatus && rawDayData.driverStatus.length === n 
                        ? rawDayData.driverStatus 
                        : Array(n).fill(true);

                    const computedDayData = { 
                        ...rawDayData, 
                        driverRanks: currentRanks,
                        ondutyStatus: ondutyStatus,
                        driverStatus: driverStatus
                    };
                    const dispatchResult = calculateDispatchLogic(computedDayData, driverNames, vehiclesList, excludedIds);

                    let dailyLastDriver = -1;
                    for (let i = dispatchResult.length - 1; i >= 0; i--) {
                        const item = dispatchResult[i];
                        for (let j = item.slots.length - 1; j >= 0; j--) {
                             const slot = item.slots[j];
                             if (slot) {
                                 if (slot.consumedAutoDriverId !== undefined) {
                                     dailyLastDriver = slot.consumedAutoDriverId;
                                     break;
                                 } else if (slot.id !== -1) {
                                     dailyLastDriver = slot.id;
                                     break;
                                 }
                             }
                        }
                        if (dailyLastDriver !== -1) break;
                    }

                    if (dailyLastDriver !== -1) {
                        lastDriverId = dailyLastDriver;
                    }

                    processedSchedule[date] = {
                        ...computedDayData,
                        dispatchResult: dispatchResult,
                        lastDriverId: dailyLastDriver !== -1 ? dailyLastDriver : lastDriverId,
                        excludedIds: excludedIds
                    };
                });
                return processedSchedule;
            }, [scheduleData, driverNames, vehiclesList]);

            const getCalculatedDayData = (dateStr) => {
                if (allScheduleWithRanks[dateStr]) {
                    return allScheduleWithRanks[dateStr];
                }
                const dates = Object.keys(allScheduleWithRanks).sort();
                const prevDates = dates.filter(d => d < dateStr);
                let lastDriverId = -1;
                if (prevDates.length > 0) {
                    lastDriverId = allScheduleWithRanks[prevDates[prevDates.length - 1]].lastDriverId;
                }

                const n = driverNames.length;
                let currentRanks = Array.from({length: n}, (_, i) => i + 1);
                if (lastDriverId !== -1) {
                    currentRanks = Array(n).fill(0);
                    let startIdx = (lastDriverId + 1) % n;
                    let currentRank = 1;
                    for (let k = 0; k < n; k++) {
                        const targetIdx = (startIdx + k) % n;
                        currentRanks[targetIdx] = currentRank++;
                    }
                }

                const getPrevDate = (d, offset) => {
                    const dateObj = new Date(d);
                    dateObj.setDate(dateObj.getDate() - offset);
                    return dateObj.toISOString().split('T')[0];
                };
                const d1 = getPrevDate(dateStr, 1);
                const d2 = getPrevDate(dateStr, 2);
                const excludedIds = new Set();
                if (allScheduleWithRanks[d1]) {
                        allScheduleWithRanks[d1].dispatchResult.forEach(r => {
                            if (r.info.duration >= 2 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && excludedIds.add(s.id));
                        });
                }
                if (allScheduleWithRanks[d2]) {
                        allScheduleWithRanks[d2].dispatchResult.forEach(r => {
                            if (r.info.duration >= 3 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && excludedIds.add(s.id));
                        });
                }

                const rawDayData = scheduleData[dateStr] || {};

                return {
                    reserved: rawDayData.reserved || {},
                    driverStatus: rawDayData.driverStatus && rawDayData.driverStatus.length === n ? rawDayData.driverStatus : Array(n).fill(true),
                    ondutyStatus: rawDayData.ondutyStatus && rawDayData.ondutyStatus.length === n ? rawDayData.ondutyStatus : Array(n).fill(false),
                    driverRanks: currentRanks,
                    overrides: rawDayData.overrides || {},
                    isHoliday: isPublicHoliday(dateStr),
                    _excludedIds: excludedIds,
                    dispatchResult: []
                };
            };

            const currentDayData = useMemo(() => {
                const data = getCalculatedDayData(selectedDateStr);
                return { ...data };
            }, [selectedDateStr, allScheduleWithRanks]);

            const calculateStatsForRange = (startYear, startMonth, endYear, endMonth) => {
                const stats = driverNames.map(nm => ({ nm, c1:0, c2:0, c3:0, tA:0, tM:0, typeCounts: {}, totalMoney: 0, totalHours: 0 }));
                for(let m = startMonth; m <= endMonth; m++) {
                    const lastD = new Date(startYear, m + 1, 0).getDate();
                    for(let d = 1; d <= lastD; d++) {
                        const dStr = `${startYear}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const dayData = getCalculatedDayData(dStr);
                        const dispatch = dayData.dispatchResult || [];
                        dispatch.forEach(item => {
                            const info = item.info;
                            if (info.isCancelled) return;
                            const t = calculateWorkHours(info.startTime, info.endTime, dayData.isHoliday, info.isHolidayWork);
                            if (!t.valid) return;
                            const pay = calculatePay(info);
                            item.slots.forEach(slot => {
                                if (slot && slot.id !== -1 && !slot.isExcluded) {
                                    const dId = slot.id;
                                    if (stats[dId]) {
                                        if (info.duration === 1) stats[dId].c1++; 
                                        else if (info.duration === 2) stats[dId].c2++; 
                                        else if (info.duration === 3) stats[dId].c3++;
                                        
                                        stats[dId].tA += t.adjusted;
                                        stats[dId].tM += pay;
                                        stats[dId].totalMoney += pay;
                                        stats[dId].totalHours += t.adjusted;
                                        const opType = info.operationType || '공공예약';
                                        stats[dId].typeCounts[opType] = (stats[dId].typeCounts[opType] || 0) + 1;
                                    }
                                }
                            });
                        });
                    }
                }
                return stats;
            };

            const handleDownloadExcel = () => {
                if (statsMode === 'monthly') {
                    const stats = calculateStatsForRange(statsYear, statsMonth, statsYear, statsMonth);
                    const yearlyStats = calculateStatsForRange(statsYear, 0, statsYear, 11);
                    const excelData = stats.map((s, idx) => {
                        return { 
                            '이름': s.nm, 
                            '당일(회)': s.c1, 
                            '1박(회)': s.c2, 
                            '2박(회)': s.c3, 
                            '공공예약(회)': s.typeCounts['공공예약'] || 0,
                            '시티투어(회)': s.typeCounts['시티투어'] || 0,
                            '성묘지원(회)': s.typeCounts['성묘지원'] || 0,
                            '나들이(회)': s.typeCounts['나들이'] || 0,
                            '기타(회)': s.typeCounts['기타'] || 0,
                            '인정 시간(h)': s.tA.toFixed(1), 
                            '금월 수당(원)': s.tM, 
                            '금년 예상합계(원)': yearlyStats[idx].totalMoney
                        };
                    });
                    
                    const totalMonth = stats.reduce((sum, s) => sum + s.tM, 0);
                    const totalMonthHours = stats.reduce((sum, s) => sum + s.tA, 0);
                    const totalYear = yearlyStats.reduce((sum, s) => sum + s.totalMoney, 0);
                    const totalC1 = stats.reduce((sum, s) => sum + s.c1, 0);
                    const totalC2 = stats.reduce((sum, s) => sum + s.c2, 0);
                    const totalC3 = stats.reduce((sum, s) => sum + s.c3, 0);
                    const totalPub = stats.reduce((sum, s) => sum + (s.typeCounts['공공예약'] || 0), 0);
                    const totalCity = stats.reduce((sum, s) => sum + (s.typeCounts['시티투어'] || 0), 0);
                    const totalGrave = stats.reduce((sum, s) => sum + (s.typeCounts['성묘지원'] || 0), 0);
                    const totalPicnic = stats.reduce((sum, s) => sum + (s.typeCounts['나들이'] || 0), 0);
                    const totalEtc = stats.reduce((sum, s) => sum + (s.typeCounts['기타'] || 0), 0);

                    excelData.push({ 
                        '이름': '총계', 
                        '당일(회)': totalC1, 
                        '1박(회)': totalC2, 
                        '2박(회)': totalC3, 
                        '공공예약(회)': totalPub,
                        '시티투어(회)': totalCity,
                        '성묘지원(회)': totalGrave,
                        '나들이(회)': totalPicnic,
                        '기타(회)': totalEtc,
                        '인정 시간(h)': totalMonthHours.toFixed(1), 
                        '금월 수당(원)': totalMonth, 
                        '금년 예상합계(원)': totalYear 
                    });
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, `${statsYear}년_${statsMonth+1}월_정산`);
                    XLSX.writeFile(wb, `배차정산_${statsYear}년_${statsMonth+1}월.xlsx`);
                } else {
                    const stats = driverNames.map(nm => ({ nm, months: Array(12).fill({m:0, h:0}), totalMoney: 0, totalHours: 0, c1:0, c2:0, c3:0, typeCounts:{} }));
                    for(let m=0; m<12; m++) {
                        const mStats = calculateStatsForRange(statsYear, m, statsYear, m);
                        mStats.forEach((d, idx) => {
                            stats[idx].months[m] = { m: d.tM, h: d.tA };
                            stats[idx].totalMoney += d.tM;
                            stats[idx].totalHours += d.tA;
                            stats[idx].c1 += d.c1;
                            stats[idx].c2 += d.c2;
                            stats[idx].c3 += d.c3;
                            Object.entries(d.typeCounts).forEach(([k, v]) => {
                                stats[idx].typeCounts[k] = (stats[idx].typeCounts[k] || 0) + v;
                            });
                        });
                    }

                    let totalC1=0, totalC2=0, totalC3=0, totalPub=0, totalCity=0, totalPicnic=0, totalGrave=0, totalEtc=0;
                    
                    const excelData = stats.map(s => {
                        totalC1 += s.c1; totalC2 += s.c2; totalC3 += s.c3;
                        totalPub += s.typeCounts['공공예약'] || 0;
                        totalCity += s.typeCounts['시티투어'] || 0;
                        totalPicnic += s.typeCounts['나들이'] || 0;
                        totalGrave += s.typeCounts['성묘지원'] || 0;
                        totalEtc += s.typeCounts['기타'] || 0;

                        const row = { 
                            '이름': s.nm,
                            '당일(회)': s.c1,
                            '1박(회)': s.c2,
                            '2박(회)': s.c3,
                            '공공예약(회)': s.typeCounts['공공예약'] || 0,
                            '시티투어(회)': s.typeCounts['시티투어'] || 0,
                            '나들이(회)': s.typeCounts['나들이'] || 0,
                            '성묘지원(회)': s.typeCounts['성묘지원'] || 0,
                            '기타(회)': s.typeCounts['기타'] || 0
                        };
                        if (yearlyViewType === 'money') {
                            s.months.forEach((d, idx) => { row[`${idx+1}월`] = d.m; });
                            row['총 인정시간(h)'] = s.totalHours.toFixed(1); row['총 수당(원)'] = s.totalMoney;
                        } else {
                            s.months.forEach((d, idx) => { row[`${idx+1}월`] = d.h.toFixed(1); });
                            row['총 인정시간(h)'] = s.totalHours.toFixed(1); row['총 수당(원)'] = s.totalMoney;
                        }
                        return row;
                    });

                    const totalRow = { 
                        '이름': '연간 합계',
                        '당일(회)': totalC1,
                        '1박(회)': totalC2,
                        '2박(회)': totalC3,
                        '공공예약(회)': totalPub,
                        '시티투어(회)': totalCity,
                        '나들이(회)': totalPicnic,
                        '성묘지원(회)': totalGrave,
                        '기타(회)': totalEtc
                    };
                    
                    let grandTotalMoney = 0; let grandTotalHours = 0;
                    for (let m = 0; m < 12; m++) {
                        const mTotalMoney = stats.reduce((sum, s) => sum + s.months[m].m, 0);
                        const mTotalHours = stats.reduce((sum, s) => sum + s.months[m].h, 0);
                        if (yearlyViewType === 'money') totalRow[`${m+1}월`] = mTotalMoney; else totalRow[`${m+1}월`] = mTotalHours.toFixed(1);
                        grandTotalMoney += mTotalMoney; grandTotalHours += mTotalHours;
                    }
                    totalRow['총 인정시간(h)'] = grandTotalHours.toFixed(1); totalRow['총 수당(원)'] = grandTotalMoney;
                    excelData.push(totalRow);

                    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, `${statsYear}년_연간정산`);
                    XLSX.writeFile(wb, `연간배차정산_${statsYear}년_${yearlyViewType === 'money' ? '수당' : '인정시간'}.xlsx`);
                }
            };

            const getUnavailableDrivers = (dateStr) => {
                const ids = new Set();
                const getPrevDate = (d, offset) => {
                    const dateObj = new Date(d);
                    dateObj.setDate(dateObj.getDate() - offset);
                    return dateObj.toISOString().split('T')[0];
                };
                const d1 = getPrevDate(dateStr, 1);
                const d2 = getPrevDate(dateStr, 2);
                if (allScheduleWithRanks[d1]) {
                        allScheduleWithRanks[d1].dispatchResult.forEach(r => {
                            if (r.info.duration >= 2 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && ids.add(s.id));
                        });
                }
                if (allScheduleWithRanks[d2]) {
                        allScheduleWithRanks[d2].dispatchResult.forEach(r => {
                            if (r.info.duration >= 3 && !r.info.isCancelled) r.slots.forEach(s => s && !s.isExcluded && ids.add(s.id));
                        });
                }
                return ids;
            }

            const getDispatchResult = () => currentDayData.dispatchResult || [];

            const handleSaveDay = async (newData) => { 
                const { _isLinked, _excludedIds, excludedIds, dispatchResult, lastDriverId, ...dataToSave } = newData; 
                await db.collection(`artifacts/${APP_ID}/public/data/calendar`).doc(selectedDateStr).set(dataToSave); 
            };
            const handleSaveMaster = async (nD, nV) => { 
                await db.doc(`artifacts/${APP_ID}/public/data/settings/master`).set({ driverNames: nD || driverNames, vehiclesList: nV || vehiclesList }); 
            };

            const addDriver = async (name) => { if (!name.trim() || driverNames.includes(name)) return; await handleSaveMaster([...driverNames, name.trim()], null); };
            const removeDriver = async (idx) => { if (!confirm("삭제하시겠습니까?")) return; const nD = [...driverNames]; nD.splice(idx, 1); await handleSaveMaster(nD, null); };
            const moveDriver = async (idx, dir) => { const nIdx = idx + dir; if (nIdx < 0 || nIdx >= driverNames.length) return; const nD = [...driverNames]; [nD[idx], nD[nIdx]] = [nD[nIdx], nD[idx]]; await handleSaveMaster(nD, null); };
            const updateDriverName = async (idx, name) => { const nD = [...driverNames]; nD[idx] = name; await handleSaveMaster(nD, null); };
            const sortDriversByRank = async () => {
                const ids = driverNames.map((_, i) => i).sort((a, b) => currentDayData.driverRanks[a] - currentDayData.driverRanks[b]);
                const newDriverNames = ids.map(i => driverNames[i]);
                await handleSaveMaster(newDriverNames, null);
            };
            const addVehicle = async (name, plate, type) => { await handleSaveMaster(null, [...vehiclesList, { id: 'V_' + Date.now(), name, plate, type, capacity: type === 'BUS' ? 2 : 1 }]); };
            const removeVehicle = async (id) => { if (confirm("삭제하시겠습니까?")) await handleSaveMaster(null, vehiclesList.filter(v => v.id !== id)); };

            const toggleDriverStatus = (idx) => { 
                const n = { ...currentDayData, driverStatus: [...currentDayData.driverStatus], overrides: { ...currentDayData.overrides } }; 
                n.driverStatus[idx] = !n.driverStatus[idx]; 
                if (!n.driverStatus[idx]) { Object.keys(n.overrides).forEach(key => { if (n.overrides[key] === idx) { delete n.overrides[key]; } }); }
                handleSaveDay(n); 
            };

            const toggleOndutyStatus = (idx) => { 
                const n = { 
                    ...currentDayData, 
                    ondutyStatus: currentDayData.ondutyStatus ? [...currentDayData.ondutyStatus] : Array(driverNames.length).fill(false) 
                }; 
                n.ondutyStatus[idx] = !n.ondutyStatus[idx]; 
                handleSaveDay(n); 
            };
            
            const updateDriverRank = (idx, val) => { 
                const n = { ...currentDayData }; n.driverRanks[idx] = parseInt(val) || 0; handleSaveDay(n); 
            };
            const toggleVehicleReservation = (vId) => {
                const n = { ...currentDayData, reserved: { ...currentDayData.reserved } };
                if (n.reserved[vId]) {
                    delete n.reserved[vId];
                    const nO = { ...n.overrides };
                    Object.keys(nO).forEach(k => { if (k.startsWith(vId)) delete nO[k]; });
                    n.overrides = nO;
                } else {
                    n.reserved[vId] = { km: 0, duration: 1, destination: '', startTime: '09:00', endTime: '18:00', custName: '', custPhone: '', memo: '', operationType: '공공예약', isHolidayWork: false, customPay: 0, isCancelled: false, isUnavailable: false };
                }
                handleSaveDay(n);
            };
            const updateVehicleInfo = (vId, field, value) => { const n = { ...currentDayData, reserved: { ...currentDayData.reserved } }; if (n.reserved[vId]) { n.reserved[vId] = { ...n.reserved[vId], [field]: value }; handleSaveDay(n); } };
            const applyReplacement = (targetKey, driverId) => { const n = { ...currentDayData, overrides: { ...currentDayData.overrides } }; if (driverId === null) delete n.overrides[targetKey]; else n.overrides[targetKey] = driverId; handleSaveDay(n); setModal({ type: null }); };
            
            const applyRotationFromYesterday = async () => {
                 alert("현재 자동 순번 연동 모드입니다. 날짜를 이동하면 자동으로 적용됩니다.");
            };

            const renderCalendarContent = (isExpanded) => {
                const cellHeight = isExpanded ? 'min-h-[300px]' : 'min-h-[112px]';
                const weekDays = ["일", "월", "화", "수", "목", "금", "토"];
                const dateTextSize = isExpanded ? "text-2xl font-extrabold" : "text-xs font-bold";
                const holidayTextSize = isExpanded ? "text-sm" : "text-[10px]";
                const groupTextSize = isExpanded 
                    ? "text-base font-extrabold p-1.5 leading-tight" 
                    : "text-[11px] font-extrabold px-1 py-0.5 leading-tight"; 
                const offTextSize = isExpanded ? "text-xs" : "text-[8px]";

                return (
                    <div className="border-t border-l border-slate-200 bg-slate-200 overflow-x-auto">
                        <div className="min-w-[700px]">
                            <div className={`grid grid-cols-7 gap-px border-b border-slate-200 bg-white`}>
                                {weekDays.map((day, idx) => (<div key={day} className={`text-center font-bold py-2 ${isExpanded ? 'text-xl' : 'text-xs'} ${idx === 0 ? "text-red-500" : idx === 6 ? "text-blue-500" : "text-slate-500"}`}>{day}</div>))}
                            </div>
                            <div className={`grid grid-cols-7 gap-px bg-slate-200`}>
                                {Array.from({length: new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay()}).map((_, i) => (<div key={`empty-${i}`} className="bg-white/50"></div>))}
                                {Array.from({length: new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate()}).map((_, i) => {
                                    const d = i + 1;
                                    const dStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                    const isSel = dStr === selectedDateStr;
                                    const dayData = getCalculatedDayData(dStr);
                                    const isH = dayData.isHoliday;
                                    const holidayName = getHolidayName(dStr); 
                                    const dayOfWeek = new Date(viewDate.getFullYear(), viewDate.getMonth(), d).getDay(); 

                                    let vehicleGroups = {};
                                    let workingDriverIds = new Set(); 

                                    for (let k = 0; k < 7; k++) {
                                        const checkDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d - k);
                                        const checkYear = checkDate.getFullYear();
                                        const checkMonth = String(checkDate.getMonth() + 1).padStart(2, '0');
                                        const checkDay = String(checkDate.getDate()).padStart(2, '0');
                                        const checkDateStr = `${checkYear}-${checkMonth}-${checkDay}`;
                                        
                                        const pastDayData = getCalculatedDayData(checkDateStr);
                                        
                                        (pastDayData.dispatchResult || []).forEach(item => {
                                            const rawDuration = item.info.duration;
                                            const duration = (rawDuration === 'seoul' || rawDuration === 'etc') ? 1 : rawDuration;

                                            if (duration > k) {
                                                let colorClass = "bg-slate-50 text-slate-800";
                                                
                                                if (item.info.isCancelled) { 
                                                    colorClass = "bg-gray-200 text-gray-500 border border-gray-300 line-through opacity-70"; 
                                                } else if (duration === 2) { 
                                                    colorClass = "bg-green-100 text-green-800"; 
                                                } else if (duration >= 3) { 
                                                    colorClass = "bg-sky-100 text-sky-800"; 
                                                } else { 
                                                    if (item.info.operationType === '공공예약') colorClass = "bg-indigo-100 text-indigo-900 font-extrabold border border-indigo-200"; 
                                                    else if (item.info.operationType === '시티투어') colorClass = "bg-blue-50 text-blue-700 font-bold border border-blue-100"; 
                                                }
                                                
                                                if (!vehicleGroups[item.vehicle.id]) {
                                                    vehicleGroups[item.vehicle.id] = { 
                                                        name: item.vehicle.name, 
                                                        drivers: [], 
                                                        color: colorClass, 
                                                        isUnavailable: item.info.isUnavailable,
                                                        isCancelled: item.info.isCancelled,
                                                        duration: duration,
                                                        rawDuration: rawDuration,
                                                        operationType: item.info.operationType 
                                                    };
                                                }
                                                
                                                item.slots.forEach(slot => {
                                                    if(slot && !slot.isExcluded) {
                                                        vehicleGroups[item.vehicle.id].drivers.push({nm: slot.nm, rank: slot.rank});
                                                        if (!item.info.isCancelled) {
                                                            workingDriverIds.add(slot.id); 
                                                        }
                                                    }
                                                });
                                            }
                                        });
                                    }

                                    let ondutyDriversStr = "";
                                    if (dayData && dayData.ondutyStatus && driverNames.length > 0) {
                                        const ondutys = driverNames.filter((_, idx) => dayData.ondutyStatus[idx]);
                                        if (ondutys.length > 0) { ondutyDriversStr = ondutys.join(', '); }
                                    }

                                    let offDriversStr = "";
                                    if (dayData && dayData.driverStatus && driverNames.length > 0) {
                                        const offs = driverNames.filter((_, idx) => !dayData.driverStatus[idx] && !workingDriverIds.has(idx));
                                        if (offs.length > 0) { offDriversStr = offs.join(', '); }
                                    }
                                    
                                    return (
                                        <div key={d} onClick={() => setSelectedDateStr(dStr)} className={`${cellHeight} p-1 transition relative cursor-pointer hover:bg-yellow-50 bg-white flex flex-col items-start justify-start gap-1 ${isSel ? 'bg-yellow-100 ring-2 ring-inset ring-yellow-300 shadow-inner' : ''} ${!isSel && isH ? 'bg-red-50/30' : ''}`}>
                                            <div className="flex items-center justify-between w-full">
                                                <span className={`${dateTextSize} ${!isSel && isH ? 'text-red-500' : dayOfWeek === 0 ? 'text-red-400' : dayOfWeek === 6 ? 'text-blue-400' : 'text-slate-700'}`}>
                                                    {d} {holidayName && <span className={`${holidayTextSize} ml-1 font-normal text-red-500 opacity-80 break-keep`}>{holidayName}</span>}
                                                </span>
                                            </div>
                                            <div className="w-full space-y-1 overflow-hidden mt-1">
                                                {Object.values(vehicleGroups).map((group, gIdx) => (
                                                    <div key={gIdx} className={`${groupTextSize} rounded truncate text-left whitespace-normal break-keep ${group.color} shadow-sm`}>
                                                        {group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-gray-500 rounded">
                                                                취소
                                                            </span>
                                                        )}
                                                        {group.rawDuration === 'etc' && !group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-purple-500 rounded">
                                                                기타
                                                            </span>
                                                        )}
                                                        {group.duration > 1 && !group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-red-500 rounded">
                                                                {group.duration - 1}박
                                                            </span>
                                                        )}
                                                        {group.operationType === '성묘지원' && !group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-blue-500 rounded">
                                                                성묘
                                                            </span>
                                                        )}
                                                        {group.operationType === '시티투어' && !group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-blue-500 rounded">
                                                                시티
                                                            </span>
                                                        )}
                                                        {group.isUnavailable && !group.isCancelled && (
                                                            <span className="inline-flex items-center justify-center px-1.5 mr-1 text-[9px] font-black leading-none text-white bg-purple-500 rounded">
                                                                운전원변경
                                                            </span>
                                                        )}
                                                        {group.isCancelled ? `${group.name} (취소됨)` : `${group.name}: ${group.drivers.length > 0 ? group.drivers.map(d => `${d.nm}(${d.rank})`).join(', ') : '공석'}`}
                                                    </div>
                                                ))}
                                            </div>
                                            {ondutyDriversStr && (
                                                <div className="w-full mt-0.5 pt-0.5 border-t border-dashed border-slate-200">
                                                    <div className={`${offTextSize} text-orange-600 truncate`}><span className="text-white bg-orange-500 px-1 py-0.5 rounded font-bold mr-1">당직</span>{ondutyDriversStr}</div>
                                                </div>
                                            )}
                                            {offDriversStr && (
                                                <div className="w-full mt-0.5 pt-0.5 border-t border-dashed border-slate-200">
                                                    <div className={`${offTextSize} text-slate-400 truncate`}><span className="text-red-300 font-bold mr-1">휴</span>{offDriversStr}</div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            if (isLoading) return <div className="flex flex-col h-screen items-center justify-center"><div className="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div><p className="mt-4 font-bold text-slate-500">배차 시스템 로드 중...</p></div>;

            const currentOffDrivers = driverNames.filter((_, i) => !currentDayData.driverStatus[i]);
            const currentOndutyDrivers = driverNames.filter((_, i) => currentDayData.ondutyStatus && currentDayData.ondutyStatus[i]);
            
            const workingDriverIds = new Set();
            getDispatchResult().forEach(item => {
                if(!item.info.isCancelled) {
                    item.slots.forEach(slot => {
                        if (slot && !slot.isExcluded) workingDriverIds.add(slot.id);
                    });
                }
            });
            const realCurrentOffDrivers = currentOffDrivers.filter((nm, i) => {
                 const originalIdx = driverNames.indexOf(nm);
                 return !workingDriverIds.has(originalIdx);
            });

            const excludedDriversList = Array.from(currentDayData._excludedIds || []).map(id => driverNames[id]).filter(n => n);

            return (
                <div className="font-sans text-slate-800 bg-slate-50 min-h-screen pb-10">
                    {/* ... (생략: 모달 및 헤더 등) ... */}
                    {isCalendarExpanded && (
                        <div className="fixed inset-0 z-[100] bg-white flex flex-col h-screen w-screen">
                            <div className="p-6 border-b shadow-sm bg-white flex justify-between items-center shrink-0">
                                <h2 className="text-2xl font-black text-slate-800">{viewDate.getFullYear()}년 {viewDate.getMonth() + 1}월 전체 일정</h2>
                                <button onClick={() => setIsCalendarExpanded(false)} className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2 text-lg shadow-sm border border-slate-200 transition-all hover:scale-105">
                                    <Icons.ArrowLeft className="w-5 h-5"/> 돌아가기
                                </button>
                            </div>
                            <div className="flex-grow p-6 overflow-auto bg-slate-50">{renderCalendarContent(true)}</div>
                        </div>
                    )}

                    <header className="sticky top-0 bg-white/90 backdrop-blur border-b z-50 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div onClick={() => window.location.reload()} className="cursor-pointer hover:opacity-80 transition-opacity">
                            <h1 className="text-xl font-extrabold text-blue-600 flex items-center gap-2">
                                <Icons.AccessibleBus className="w-6 h-6"/> 배차관리
                            </h1>
                            <div className="flex items-center gap-2">
                                <p className="text-[10px] text-emerald-500 font-bold flex items-center gap-1"><span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> 실시간 접속중</p>
                                {autoLinked && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold animate-bounce transition-all flex items-center gap-1"><Icons.Link className="w-3 h-3"/>전일 데이터 연동됨</span>}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setModal({ type: 'vehicles' })} className="bg-indigo-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow hover:bg-indigo-600 transition flex items-center gap-1"><Icons.Bus className="w-3 h-3"/>차량 관리</button>
                            <button onClick={() => setModal({ type: 'data' })} className="bg-slate-100 text-slate-700 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-slate-200 transition flex items-center gap-1"><Icons.Database className="w-3 h-3"/>데이터 관리</button>
                            <button onClick={() => { setStatsYear(viewDate.getFullYear()); setStatsMonth(viewDate.getMonth()); setModal({ type: 'stats' }); }} className="bg-emerald-500 text-white px-3 py-1.5 rounded-xl text-xs font-bold shadow hover:bg-emerald-600 transition flex items-center gap-1"><Icons.PieChart className="w-3 h-3"/>정산</button>
                            <button onClick={resetAll} className="bg-slate-100 text-slate-500 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-red-50 hover:text-red-500 transition"><Icons.RotateCw className="w-3 h-3"/></button>
                        </div>
                    </header>

                    <div className="p-4 md:p-6 flex flex-col lg:flex-row gap-6 relative">
                        <div className="flex-shrink-0 space-y-6" style={{ width: isDesktop ? leftPanelWidth : '100%' }}>
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-4 font-bold">
                                    <h2 className="text-lg">{viewDate.getFullYear()}년 {viewDate.getMonth() + 1}월</h2>
                                    <div className="flex gap-1 items-center">
                                        <button onClick={() => setIsCalendarExpanded(true)} className="w-8 h-8 rounded-full hover:bg-blue-50 text-blue-600 mr-2 flex items-center justify-center" title="확대보기"><Icons.Maximize className="w-4 h-4"/></button>
                                        <button onClick={() => moveMonth(-1)} className="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><Icons.ChevronLeft className="w-4 h-4"/></button>
                                        <button onClick={() => moveMonth(1)} className="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center"><Icons.ChevronRight className="w-4 h-4"/></button>
                                    </div>
                                </div>
                                {renderCalendarContent(false)}
                            </div>
                            
                            {/* 최종 배차 결과 복원 영역 */}
                            <div className="bg-white rounded-3xl shadow-sm p-6 text-slate-900 min-h-[400px] border border-slate-200 font-bold">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-lg font-extrabold flex items-center gap-2 text-slate-800"><Icons.Receipt className="text-emerald-600 w-5 h-5"/> 최종 배차 결과</h2>
                                    <span className="text-sm text-slate-500 font-bold">{selectedDateStr}</span>
                                </div>
                                <div className="space-y-4">
                                    {getDispatchResult().map((item, idx) => {
                                        const t = calculateWorkHours(item.info.startTime, item.info.endTime, currentDayData.isHoliday, item.info.isHolidayWork);
                                        const pay = calculatePay(item.info);

                                        return (
                                            <div key={idx} className="p-5 rounded-2xl bg-white border border-slate-200 shadow-sm transition-all hover:bg-slate-50 hover:shadow-md">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-10 h-10 rounded-xl bg-slate-100 border border-slate-200 flex items-center justify-center text-sm text-blue-600 font-black shadow-sm">{item.vehicle.type[0]}</div>
                                                        <div>
                                                            <div className="text-base font-black text-slate-900">{item.vehicle.name} <span className="text-xs text-slate-500 font-normal ml-1">{item.vehicle.plate}</span></div>
                                                            <div className="text-sm text-emerald-600 font-bold mt-0.5">{item.info.destination || '미입력'}</div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        {item.info.isCancelled && <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold mr-1">취소됨</span>}
                                                        {item.info.isUnavailable && <span className="text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold mr-1">운전원변경</span>}
                                                        <span className="text-xs bg-white border border-slate-200 px-2.5 py-1 rounded-md text-slate-600 shadow-sm font-bold">
                                                            {item.info.duration === 'seoul' ? '서울' : (item.info.duration === 'etc' ? '기타' : (item.info.duration > 1 ? (item.info.duration-1)+'박' : '당일'))}
                                                        </span>
                                                        <div className="text-xs text-slate-500 mt-1.5 font-medium">{item.info.startTime}~{item.info.endTime}</div>
                                                        <div className="mt-1.5"><span className="text-xs bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100 font-bold">{item.info.operationType || '공공예약'}</span></div>
                                                    </div>
                                                </div>
                                                {item.info.custName && <div className="mb-4 px-3 py-2 bg-slate-50 border border-slate-100 rounded-lg text-sm font-bold text-slate-700 shadow-sm flex items-center gap-2"><Icons.UserCheck className="w-3 h-3 text-slate-400"/> 예약: {item.info.custName} ({item.info.custPhone})</div>}
                                                <div className="grid grid-cols-4 gap-2 py-3 border-y border-slate-200 mb-4 text-center text-xs">
                                                    <div><div className="text-slate-400 mb-1">실근무</div><div className="font-extrabold text-slate-700 text-sm">{item.info.isCancelled ? 0 : t.work}h</div></div>
                                                    <div><div className="text-slate-400 mb-1">{currentDayData.isHoliday || item.info.isHolidayWork ? '휴일' : '초과'}</div><div className="text-red-500 font-extrabold text-sm">{item.info.isCancelled ? 0 : t.extra}h</div></div>
                                                    <div><div className="text-blue-500 mb-1">인정</div><div className="text-base text-blue-700 font-black">{item.info.isCancelled ? 0 : t.adjusted}h</div></div>
                                                    <div className="border-l border-slate-200 pl-2"><div className="text-emerald-500 mb-1">금액</div><div className="text-base text-emerald-700 font-black">{item.info.isCancelled ? 0 : pay.toLocaleString()}</div></div>
                                                </div>
                                                
                                                {!item.info.isCancelled && (
                                                    <div className="flex flex-wrap gap-2">
                                                        {item.slots.map((d, sIdx) => {
                                                            const isAssigned = d && !d.isExcluded;
                                                            return isAssigned ? (
                                                                <button key={sIdx} onClick={() => setModal({ type: 'replace', data: { vId: item.vehicle.id, sIdx } })} className={`flex-grow py-2.5 rounded-xl text-xs font-bold border flex items-center justify-center gap-1 shadow-sm transition-all ${d.type==='manual' ? 'bg-orange-50 border-orange-200 text-orange-700 hover:bg-orange-100' : 'bg-white border-slate-200 text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200'}`}>
                                                                    {d.nm} <span className="text-[10px] opacity-60 ml-1 font-normal">({d.rank}순위)</span> {d.type==='manual' && <div className="w-1.5 h-1.5 bg-orange-500 rounded-full"></div>}
                                                                </button>
                                                            ) : (
                                                                <button key={sIdx} onClick={() => setModal({ type: 'replace', data: { vId: item.vehicle.id, sIdx } })} className="flex-grow py-2.5 bg-red-50 border border-red-100 rounded-xl text-xs text-red-500 font-bold animate-pulse hover:bg-red-100">공석 배정하기</button>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                                {item.info.isUnavailable && (
                                                    <div className="text-center py-2 mt-2 text-purple-600 text-xs font-bold bg-purple-50 rounded-xl border border-purple-100">운전원변경 (자동 배차가 제외되었습니다)</div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {getDispatchResult().length === 0 && <div className="text-center py-20 text-slate-400 text-sm font-medium italic">등록된 예약 내역이 없습니다.</div>}
                                    
                                    <div className="mt-6 pt-4 border-t border-slate-200">
                                        <div className="flex items-center gap-2 mb-3 text-slate-500 text-xs font-bold uppercase tracking-wider">
                                            <Icons.UserX className="w-3 h-3"/> <span>당직 / 휴무 / 연박 인원</span>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {currentOndutyDrivers.map((nm, i) => (
                                                <span key={`onduty-${i}`} className="px-2.5 py-1 rounded-md bg-orange-100 border border-orange-200 text-orange-700 text-xs font-bold">당직: {nm}</span>
                                            ))}
                                            {realCurrentOffDrivers.map((nm, i) => (
                                                <span key={`off-${i}`} className="px-2.5 py-1 rounded-md bg-slate-100 border border-slate-200 text-slate-500 text-xs font-bold">휴무: {nm}</span>
                                            ))}
                                            {excludedDriversList.map((nm, i) => (
                                                <span key={`excl-${i}`} className="px-2.5 py-1 rounded-md bg-rose-50 border border-rose-200 text-rose-600 text-xs font-bold">연박: {nm}</span>
                                            ))}
                                            {currentOndutyDrivers.length === 0 && realCurrentOffDrivers.length === 0 && excludedDriversList.length === 0 && <span className="text-slate-400 text-xs pl-1">해당 인원 없음</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-4 font-bold">
                                    <h2 className="text-sm">운전자 관리</h2>
                                    <button onClick={sortDriversByRank} className="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 font-bold">순번 정렬</button>
                                </div>
                                <div className="flex gap-2 mb-4">
                                    <input type="text" id="addDriverInput" className="flex-grow text-xs border rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-400 bg-slate-50 font-bold" placeholder="이름 입력" onKeyDown={(e) => { if(e.key==='Enter') { addDriver(e.target.value); e.target.value=''; }}} />
                                    <button onClick={() => { const el = document.getElementById('addDriverInput'); addDriver(el.value); el.value=''; }} className="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center"><Icons.Plus className="w-4 h-4"/></button>
                                </div>
                                <div className="space-y-1 h-[500px] overflow-y-auto pr-1">
                                    {driverNames.map((nm, i) => (
                                        <div key={i} className={`flex items-center justify-between p-2 rounded-lg border text-xs font-bold group transition ${currentDayData.driverStatus[i] ? 'bg-white border-blue-100' : 'bg-slate-50 border-slate-200'}`}>
                                            <div className="flex items-center gap-2 flex-grow">
                                                <button onClick={() => toggleDriverStatus(i)} className={`px-2 py-1 rounded-md text-[10px] w-10 flex-shrink-0 transition-colors ${currentDayData.driverStatus[i] ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-slate-200 text-slate-500 hover:bg-slate-300'}`}>{currentDayData.driverStatus[i] ? '출근' : '휴무'}</button>
                                                <button onClick={() => toggleOndutyStatus(i)} className={`px-2 py-1 rounded-md text-[10px] w-10 flex-shrink-0 transition-colors ${currentDayData.ondutyStatus?.[i] ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-slate-200 text-slate-500 hover:bg-slate-300'}`}>당직</button>
                                                <AutoSaveInput value={nm} onSave={(val) => updateDriverName(i, val)} className={`bg-transparent outline-none w-full ${!currentDayData.driverStatus[i] ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-700'}`} />
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <div className="flex flex-col">
                                                    <button onClick={() => moveDriver(i, -1)} className="text-[8px] text-slate-300 hover:text-blue-500"><Icons.ChevronUp className="w-3 h-3"/></button>
                                                    <button onClick={() => moveDriver(i, 1)} className="text-[8px] text-slate-300 hover:text-blue-500"><Icons.ChevronDown className="w-3 h-3"/></button>
                                                </div>
                                                <AutoSaveInput type="number" value={currentDayData.driverRanks[i]} onSave={(val) => updateDriverRank(i, val)} className="w-7 text-center border rounded bg-slate-50" />
                                                <button onClick={() => removeDriver(i)} className="text-red-200 hover:text-red-500 ml-1"><Icons.Trash2 className="w-3 h-3"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="hidden lg:block w-2 bg-slate-200 hover:bg-blue-400 cursor-col-resize rounded-full transition-colors self-stretch flex-shrink-0 z-10" onMouseDown={handleMouseDown}></div>

                        <div className="flex-1 min-w-0 space-y-6">
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 min-h-[600px]">
                                {/* ... 배차 예약 정보 입력 헤더 ... */}
                                <div className="flex justify-between items-center mb-6 border-b pb-4 font-bold">
                                    <div className="flex flex-col font-bold">
                                        <span id="selectedDateLabel" className="text-blue-600 text-sm font-extrabold mb-1 font-bold">{selectedDateStr}</span>
                                        <h2 className="text-xl font-black text-slate-800 font-bold">배차 예약 정보 입력</h2>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    {vehiclesList.map(v => {
                                        const isReserved = !!currentDayData.reserved[v.id];
                                        const info = isReserved ? currentDayData.reserved[v.id] : {};
                                        
                                        const currentDispatch = getDispatchResult().find(d => d.vehicle.id === v.id);
                                        const assignedDrivers = currentDispatch && currentDispatch.slots ? currentDispatch.slots.filter(s => s && !s.isExcluded).map(s => s.nm).join(', ') : '';

                                        return (
                                            <div key={v.id} className={`p-4 rounded-2xl border-2 transition-all ${isReserved ? 'border-blue-500 bg-white shadow-md' : 'border-slate-100 bg-slate-50 opacity-70'} font-bold`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="flex flex-col">
                                                        <label className="flex items-center gap-3 cursor-pointer">
                                                            <input type="checkbox" checked={isReserved} onChange={() => toggleVehicleReservation(v.id)} className="w-5 h-5 rounded text-blue-600"/>
                                                            <div><div className="text-sm font-black">{v.name}</div><div className="text-[10px] text-slate-400 font-mono">{v.plate}</div></div>
                                                        </label>
                                                        {isReserved && assignedDrivers && !info.isCancelled && (
                                                            <div className="ml-8 mt-1 text-xs text-blue-600 font-bold flex items-center gap-1">
                                                                <Icons.UserCheck className="w-3 h-3"/> {assignedDrivers}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {isReserved ? (
                                                            <div className="flex gap-2">
                                                                <button onClick={() => toggleVehicleReservation(v.id)} className="bg-red-100 text-red-500 text-[10px] px-2 py-1 rounded">삭제</button>
                                                            </div>
                                                        ) : (v.type === 'BUS' ? <Icons.Bus className="text-slate-300 w-5 h-5"/> : <Icons.BusFront className="text-slate-300 w-5 h-5"/>)}
                                                    </div>
                                                </div>
                                                {isReserved && (
                                                    <div className="mt-3 pt-3 border-t border-blue-50 space-y-3 animate-[fadeIn_0.2s_ease-out]">
                                                        <div className="flex flex-wrap gap-4 mb-2">
                                                            <label className="flex items-center gap-2">
                                                                <input type="checkbox" checked={info.isHolidayWork || false} onChange={(e) => updateVehicleInfo(v.id, 'isHolidayWork', e.target.checked)} className="w-4 h-4 text-orange-500 rounded"/>
                                                                <span className="text-xs text-orange-600 font-bold">휴일 시간 적용</span>
                                                            </label>
                                                            <label className="flex items-center gap-2">
                                                                <input type="checkbox" checked={info.isCancelled || false} onChange={(e) => updateVehicleInfo(v.id, 'isCancelled', e.target.checked)} className="w-4 h-4 text-red-500 rounded"/>
                                                                <span className="text-xs text-red-600 font-bold">예약 취소 (미운행)</span>
                                                            </label>
                                                            <label className="flex items-center gap-2">
                                                                <input type="checkbox" checked={info.isUnavailable || false} onChange={(e) => updateVehicleInfo(v.id, 'isUnavailable', e.target.checked)} className="w-4 h-4 text-purple-500 rounded"/>
                                                                <span className="text-xs text-purple-600 font-bold">운전원변경</span>
                                                            </label>
                                                        </div>

                                                        <div className="grid grid-cols-2 gap-2">
                                                            <AutoSaveInput value={info.custName} onSave={(val) => updateVehicleInfo(v.id, 'custName', val)} placeholder="예약자명" className="text-xs border rounded-lg p-2 outline-none bg-white font-extrabold shadow-sm font-bold"/>
                                                            <AutoSaveInput value={info.custPhone} onSave={(val) => updateVehicleInfo(v.id, 'custPhone', val)} placeholder="연락처" className="text-xs border rounded-lg p-2 outline-none bg-white font-extrabold shadow-sm font-bold"/>
                                                        </div>
                                                        <AutoSaveInput value={info.destination} onSave={(val) => updateVehicleInfo(v.id, 'destination', val)} placeholder="행선지" className="w-full text-xs border rounded-lg p-2 outline-none bg-white font-extrabold shadow-sm font-bold"/>
                                                        
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <div className="flex items-center gap-1">
                                                                <span className="text-[10px] text-slate-500 w-12 font-bold">운행형태</span>
                                                                <select value={info.operationType || '공공예약'} onChange={(e) => updateVehicleInfo(v.id, 'operationType', e.target.value)} className="w-full text-xs border rounded-lg p-2 bg-slate-50 focus:bg-white outline-none font-bold">
                                                                    <option value="공공예약">공공예약</option>
                                                                    <option value="시티투어">시티투어</option>
                                                                    <option value="성묘지원">성묘지원</option>
                                                                    <option value="나들이">나들이</option>
                                                                    <option value="기타">기타</option>
                                                                </select>
                                                            </div>
                                                            <div className="flex items-center gap-1 border rounded-lg p-1.5 bg-white"><input type="number" step="0.1" value={info.km} onChange={(e) => updateVehicleInfo(v.id, 'km', parseFloat(e.target.value) || 0)} className="w-full text-right text-xs border-none outline-none font-extrabold font-bold"/><span className="text-[10px] text-slate-400">km</span></div>
                                                        </div>

                                                        {(info.operationType === '성묘지원' || info.operationType === '나들이' || info.operationType === '시티투어' || info.duration === 'etc') && (
                                                            <div className="flex items-center gap-1 border border-emerald-300 rounded-lg p-1.5 bg-emerald-50">
                                                                <span className="text-[10px] text-emerald-600 font-bold w-8">금액</span>
                                                                <AutoSaveInput type="number" value={info.customPay} onSave={(val) => updateVehicleInfo(v.id, 'customPay', val)} placeholder="금액(원)" className="w-full text-right text-xs bg-transparent outline-none font-extrabold font-bold text-emerald-700"/>
                                                            </div>
                                                        )}

                                                        <div className="grid grid-cols-2 gap-2">
                                                            <div className="flex items-center gap-1"><span className="text-[10px] text-slate-400 w-6">출근</span><input type="time" value={info.startTime} onChange={(e) => updateVehicleInfo(v.id, 'startTime', e.target.value)} className="w-full text-xs border rounded-lg p-1.5 font-bold"/></div>
                                                            <div className="flex items-center gap-1"><span className="text-[10px] text-slate-400 w-6">종료</span><input type="time" value={info.endTime} onChange={(e) => updateVehicleInfo(v.id, 'endTime', e.target.value)} className="w-full text-xs border rounded-lg p-1.5 font-bold"/></div>
                                                        </div>
                                                        <select value={info.duration} onChange={(e) => updateVehicleInfo(v.id, 'duration', (e.target.value === 'seoul' || e.target.value === 'etc') ? e.target.value : parseInt(e.target.value))} className="w-full text-center text-xs border rounded-lg p-2 bg-white font-bold mt-1">
                                                            <option value={1}>당일 (1.25만)</option>
                                                            <option value={2}>1박 (7.0만)</option>
                                                            <option value={3}>2박 (10.5만)</option>
                                                            <option value="seoul">서울 (0원)</option>
                                                            <option value="etc">기타 (직접입력)</option>
                                                        </select>
                                                        <AutoSaveInput value={info.memo} onSave={(val) => updateVehicleInfo(v.id, 'memo', val)} placeholder="메모" className="w-full text-xs border rounded-lg p-2 outline-none bg-slate-50 focus:bg-white mt-2"/>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    {/* Footer */}
                    <footer className="w-full py-8 bg-slate-50 text-center border-t border-slate-200 mt-8">
                        <div className="flex flex-col items-center justify-center gap-2 text-slate-400">
                            <div className="flex items-center gap-2 mb-1">
                                <Icons.Palette className="w-4 h-4"/>
                                <span className="text-xs font-bold uppercase tracking-widest">Design by Tak</span>
                            </div>
                            <p className="text-[10px]">© 2024 Vehicle Dispatch System. All rights reserved.</p>
                        </div>
                    </footer>

                    {/* ... (모달 코드들 - vehicles, replace, data, stats - 유지) ... */}
                    {modal.type === 'vehicles' && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
                                <div className="p-4 border-b font-bold flex justify-between">
                                    <h3>보유 차량 관리</h3>
                                    <button onClick={() => setModal({ type: null })}><Icons.X className="w-4 h-4"/></button>
                                </div>
                                <div className="p-6">
                                    <div className="flex gap-2 mb-3 bg-slate-50 p-2 rounded-xl">
                                        <input type="text" id="addVName" placeholder="호차명" className="w-1/3 text-xs border rounded p-1.5 outline-none"/>
                                        <input type="text" id="addVPlate" placeholder="번호" className="w-1/3 text-xs border rounded p-1.5 outline-none"/>
                                        <select id="addVType" className="w-1/3 text-xs border rounded p-1.5 outline-none">
                                            <option value="BUS">버스</option>
                                            <option value="SOLATI">솔라티</option>
                                        </select>
                                        <button onClick={()=>{
                                            const n=document.getElementById('addVName').value, p=document.getElementById('addVPlate').value, t=document.getElementById('addVType').value;
                                            if(!n) return; 
                                            addVehicle(n,p,t);
                                            document.getElementById('addVName').value=''; document.getElementById('addVPlate').value='';
                                        }} className="bg-slate-800 text-white w-12 rounded text-xs shrink-0">등록</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 max-h-[400px] overflow-y-auto">
                                        {vehiclesList.map(v => (
                                            <div key={v.id} className="flex justify-between items-center p-3 border rounded-lg text-sm font-bold bg-white">
                                                <div className="flex flex-col">
                                                    <span>{v.name}</span>
                                                    <span className="text-[10px] text-slate-400 font-normal">{v.plate}</span>
                                                </div>
                                                <button onClick={() => removeVehicle(v.id)} className="text-red-300 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {modal.type === 'replace' && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
                                <div className="p-4 border-b font-bold flex justify-between">
                                    <h3>대체 운전자 선택</h3>
                                    <button onClick={() => setModal({ type: null })}><Icons.X className="w-4 h-4"/></button>
                                </div>
                                <div className="p-2 max-h-[400px] overflow-y-auto">
                                    {driverNames.map((nm, idx) => (
                                        <button key={idx} onClick={() => applyReplacement(`${modal.data.vId}_${modal.data.sIdx}`, idx)} className="w-full p-3 text-left font-bold text-sm border-b border-slate-50 hover:bg-blue-50 flex justify-between">
                                            <span>{currentDayData.driverRanks[idx]}위 {nm}</span>
                                            <span className={`text-xs ${currentDayData.driverStatus[idx] ? 'text-blue-500' : 'text-slate-300'}`}>{currentDayData.driverStatus[idx] ? '출근' : '휴무'}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="p-3 border-t">
                                    <button onClick={() => applyReplacement(`${modal.data.vId}_${modal.data.sIdx}`, null)} className="w-full py-2 bg-red-50 text-red-500 text-xs font-bold rounded-lg">수동 배정 해제</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {modal.type === 'data' && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl">
                                <div className="p-4 border-b font-bold flex justify-between">
                                    <h3>데이터 관리</h3>
                                    <button onClick={() => setModal({ type: null })}><Icons.X className="w-4 h-4"/></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <button onClick={handleBackup} className="w-full py-3 bg-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-600 transition">
                                        <Icons.Download className="w-5 h-5"/> 백업 데이터 다운로드
                                    </button>
                                    <div className="relative">
                                        <input type="file" accept=".json" onChange={handleRestore} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                        <button className="w-full py-3 bg-slate-100 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 transition border border-slate-200">
                                            <Icons.Upload className="w-5 h-5"/> 백업 파일로 복원
                                        </button>
                                    </div>
                                    <p className="text-xs text-slate-400 text-center mt-2">
                                        * 백업 파일(.json)을 선택하면 현재 데이터가 덮어씌워집니다.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    {modal.type === 'stats' && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-[95vw] lg:max-w-7xl rounded-2xl overflow-hidden shadow-2xl h-[85vh] flex flex-col">
                                <div className="p-5 border-b font-bold flex flex-col gap-3 bg-slate-50">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-4">
                                            <div className="flex items-center bg-white rounded-lg shadow-sm border border-slate-200 px-2 py-1">
                                                <button onClick={() => setStatsYear(y => y - 1)} className="p-1 hover:text-blue-600 transition"><Icons.ChevronLeft className="w-4 h-4"/></button>
                                                <span className="mx-2 text-lg font-black text-slate-700 min-w-[60px] text-center">{statsYear}년</span>
                                                <button onClick={() => setStatsYear(y => y + 1)} className="p-1 hover:text-blue-600 transition"><Icons.ChevronRight className="w-4 h-4"/></button>
                                            </div>
                                            {statsMode === 'monthly' && (
                                                <div className="flex items-center bg-white rounded-lg shadow-sm border border-slate-200 px-2 py-1">
                                                    <button onClick={() => setStatsMonth(m => m === 0 ? 11 : m - 1)} className="p-1 hover:text-blue-600 transition"><Icons.ChevronLeft className="w-4 h-4"/></button>
                                                    <span className="mx-2 text-lg font-black text-slate-700 min-w-[40px] text-center">{statsMonth + 1}월</span>
                                                    <button onClick={() => setStatsMonth(m => m === 11 ? 0 : m + 1)} className="p-1 hover:text-blue-600 transition"><Icons.ChevronRight className="w-4 h-4"/></button>
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={() => setModal({ type: null })} className="text-slate-400 hover:text-slate-600"><Icons.X className="w-6 h-6"/></button>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <div className="flex gap-2">
                                            <div className="flex bg-white rounded-lg p-1 shadow-sm border border-slate-200">
                                                <button onClick={() => setStatsMode('monthly')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition ${statsMode === 'monthly' ? 'bg-blue-600 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>월별 상세</button>
                                                <button onClick={() => setStatsMode('yearly')} className={`px-4 py-1.5 text-xs font-bold rounded-md transition ${statsMode === 'yearly' ? 'bg-blue-600 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>연간 집계</button>
                                            </div>
                                            {statsMode === 'yearly' && (
                                                <div className="flex bg-white rounded-lg p-1 shadow-sm border border-slate-200">
                                                    <button onClick={() => setYearlyViewType('money')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition flex items-center gap-1 ${yearlyViewType === 'money' ? 'bg-emerald-500 text-white' : 'text-slate-500 hover:bg-slate-50'}`}><Icons.Money className="w-3 h-3"/> 수당</button>
                                                    <button onClick={() => setYearlyViewType('hours')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition flex items-center gap-1 ${yearlyViewType === 'hours' ? 'bg-orange-500 text-white' : 'text-slate-500 hover:bg-slate-50'}`}><Icons.Clock className="w-3 h-3"/> 인정시간</button>
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={handleDownloadExcel} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700 transition flex items-center gap-1 shadow-sm"><Icons.FileExcel className="w-3 h-3"/> 엑셀 다운로드</button>
                                    </div>
                                </div>
                                <div className="flex-grow overflow-auto p-0 bg-white">
                                    {statsMode === 'monthly' ? (
                                        <div className="p-6 overflow-x-auto">
                                            <table className="w-full text-left font-bold text-sm stats-table min-w-[900px]">
                                                <thead>
                                                    <tr className="text-slate-500 border-b text-xs uppercase bg-slate-50">
                                                        <th className="pb-2 pl-4">이름</th>
                                                        <th className="text-center pb-2">당일</th>
                                                        <th className="text-center pb-2">1박</th>
                                                        <th className="text-center pb-2">2박</th>
                                                        <th className="text-center pb-2 border-l border-slate-200">공공</th>
                                                        <th className="text-center pb-2">시티</th>
                                                        <th className="text-center pb-2">나들이</th>
                                                        <th className="text-center pb-2">성묘</th>
                                                        <th className="text-center pb-2">기타</th>
                                                        <th className="text-right pb-2 border-l border-slate-200">인정(h)</th>
                                                        <th className="text-right pb-2">금월 수당</th>
                                                        <th className="text-right pb-2 pr-4 bg-blue-50 text-blue-700">금년 예상합계</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(() => {
                                                        const stats = calculateStatsForRange(statsYear, statsMonth, statsYear, statsMonth);
                                                        const yearlyStatsAll = calculateStatsForRange(statsYear, 0, statsYear, 11);
                                                        
                                                        const totalPay = stats.reduce((acc, curr) => acc + curr.tM, 0);
                                                        const totalHours = stats.reduce((acc, curr) => acc + curr.tA, 0);
                                                        const totalYearPay = yearlyStatsAll.reduce((acc, curr) => acc + curr.totalMoney, 0);
                                                        
                                                        const totalC1 = stats.reduce((acc, curr) => acc + curr.c1, 0);
                                                        const totalC2 = stats.reduce((acc, curr) => acc + curr.c2, 0);
                                                        const totalC3 = stats.reduce((acc, curr) => acc + curr.c3, 0);
                                                        const totalPub = stats.reduce((acc, curr) => acc + (curr.typeCounts['공공예약'] || 0), 0);
                                                        const totalCity = stats.reduce((acc, curr) => acc + (curr.typeCounts['시티투어'] || 0), 0);
                                                        const totalPicnic = stats.reduce((acc, curr) => acc + (curr.typeCounts['나들이'] || 0), 0);
                                                        const totalGrave = stats.reduce((acc, curr) => acc + (curr.typeCounts['성묘지원'] || 0), 0);
                                                        const totalEtc = stats.reduce((acc, curr) => acc + (curr.typeCounts['기타'] || 0), 0);

                                                        return (
                                                            <>
                                                                {stats.map((s, i) => (
                                                                    <tr key={i} className="border-b border-slate-50 hover:bg-slate-50 transition">
                                                                        <td className="py-3 pl-4 font-extrabold">{s.nm}</td>
                                                                        <td className={`text-center ${s.c1 > 0 ? 'text-slate-700' : 'text-slate-300'}`}>{s.c1 > 0 ? s.c1 : '-'}</td>
                                                                        <td className={`text-center ${s.c2 > 0 ? 'text-blue-500' : 'text-slate-300'}`}>{s.c2 > 0 ? s.c2 : '-'}</td>
                                                                        <td className={`text-center ${s.c3 > 0 ? 'text-orange-500' : 'text-slate-300'}`}>{s.c3 > 0 ? s.c3 : '-'}</td>
                                                                        <td className={`text-center border-l border-slate-100 ${s.typeCounts['공공예약'] > 0 ? 'text-slate-700' : 'text-slate-300'}`}>{s.typeCounts['공공예약'] || '-'}</td>
                                                                        <td className={`text-center ${s.typeCounts['시티투어'] > 0 ? 'text-blue-600' : 'text-slate-300'}`}>{s.typeCounts['시티투어'] || '-'}</td>
                                                                        <td className={`text-center ${s.typeCounts['나들이'] > 0 ? 'text-emerald-500' : 'text-slate-300'}`}>{s.typeCounts['나들이'] || '-'}</td>
                                                                        <td className={`text-center ${s.typeCounts['성묘지원'] > 0 ? 'text-indigo-500' : 'text-slate-300'}`}>{s.typeCounts['성묘지원'] || '-'}</td>
                                                                        <td className={`text-center ${s.typeCounts['기타'] > 0 ? 'text-purple-500' : 'text-slate-300'}`}>{s.typeCounts['기타'] || '-'}</td>
                                                                        <td className="text-right text-blue-600 font-black border-l border-slate-100">{s.tA.toFixed(1)}</td>
                                                                        <td className="text-right text-emerald-600 font-black">{s.tM.toLocaleString()}</td>
                                                                        <td className="text-right font-black bg-blue-50/50 text-blue-800 pr-4 border-l border-slate-100">{yearlyStatsAll[i].totalMoney.toLocaleString()}</td>
                                                                    </tr>
                                                                ))}
                                                                <tr className="bg-slate-100 border-t-2 border-slate-200">
                                                                    <td className="py-4 pl-4 text-left font-black text-slate-600">월 총계</td>
                                                                    <td className="py-4 text-center font-black text-slate-700">{totalC1}</td>
                                                                    <td className="py-4 text-center font-black text-blue-600">{totalC2}</td>
                                                                    <td className="py-4 text-center font-black text-orange-600">{totalC3}</td>
                                                                    <td className="py-4 text-center font-black text-slate-700 border-l border-slate-200">{totalPub}</td>
                                                                    <td className="py-4 text-center font-black text-blue-600">{totalCity}</td>
                                                                    <td className="py-4 text-center font-black text-emerald-600">{totalPicnic}</td>
                                                                    <td className="py-4 text-center font-black text-indigo-600">{totalGrave}</td>
                                                                    <td className="py-4 text-center font-black text-purple-600">{totalEtc}</td>
                                                                    <td className="py-4 text-right font-black text-blue-600 text-sm border-l border-slate-200">{totalHours.toFixed(1)}h</td>
                                                                    <td className="py-4 text-right font-black text-emerald-600 text-lg">{totalPay.toLocaleString()}</td>
                                                                    <td className="py-4 pr-4 text-right font-black text-blue-700 text-lg border-l border-slate-200 bg-blue-100">{totalYearPay.toLocaleString()}</td>
                                                                </tr>
                                                            </>
                                                        );
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="p-6 overflow-x-auto">
                                            <table className="w-full text-left font-bold text-xs stats-table min-w-[1200px]">
                                                <thead>
                                                    <tr className="bg-slate-50 border-b text-slate-600 text-xs uppercase">
                                                        <th className="pl-4 py-3 sticky left-0 bg-slate-50 z-20 border-r border-slate-200">이름</th>
                                                        <th className="text-center px-2">당일</th>
                                                        <th className="text-center px-2">1박</th>
                                                        <th className="text-center px-2">2박</th>
                                                        <th className="text-center px-2 border-l border-slate-200">공공</th>
                                                        <th className="text-center px-2">시티</th>
                                                        <th className="text-center px-2">나들이</th>
                                                        <th className="text-center px-2">성묘</th>
                                                        <th className="text-center px-2">기타</th>
                                                        {Array.from({length: 12}).map((_, m) => (<th key={m} className={`text-right px-2 min-w-[60px] ${m===0 ? 'border-l border-slate-200' : ''}`}>{m+1}월</th>))}
                                                        <th className="text-right pr-4 bg-blue-50 text-blue-700 z-10 sticky right-0 border-l border-slate-200">합계</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(() => {
                                                        const stats = driverNames.map(nm => ({ nm, months: Array(12).fill({m:0, h:0}), totalMoney:0, totalHours:0, c1:0, c2:0, c3:0, typeCounts:{} }));
                                                        for(let m=0; m<12; m++) {
                                                            const mStats = calculateStatsForRange(statsYear, m, statsYear, m);
                                                            mStats.forEach((d, idx) => {
                                                                stats[idx].months[m] = { m: d.tM, h: d.tA };
                                                                stats[idx].totalMoney += d.tM;
                                                                stats[idx].totalHours += d.tA;
                                                                stats[idx].c1 += d.c1;
                                                                stats[idx].c2 += d.c2;
                                                                stats[idx].c3 += d.c3;
                                                                Object.entries(d.typeCounts).forEach(([k, v]) => {
                                                                    stats[idx].typeCounts[k] = (stats[idx].typeCounts[k] || 0) + v;
                                                                });
                                                            });
                                                        }
                                                        
                                                        let monthlyTotals = Array(12).fill(0);
                                                        let grandTotal = 0;
                                                        let totalC1=0, totalC2=0, totalC3=0, totalPub=0, totalCity=0, totalPicnic=0, totalGrave=0, totalEtc=0;
                                                        
                                                        const rows = stats.map((s, i) => {
                                                            s.months.forEach((d, m) => { monthlyTotals[m] += (yearlyViewType === 'money' ? d.m : d.h); });
                                                            const rowTotal = yearlyViewType === 'money' ? s.totalMoney : s.totalHours;
                                                            grandTotal += rowTotal;
                                                            
                                                            totalC1 += s.c1; totalC2 += s.c2; totalC3 += s.c3;
                                                            totalPub += (s.typeCounts['공공예약'] || 0);
                                                            totalCity += (s.typeCounts['시티투어'] || 0);
                                                            totalPicnic += (s.typeCounts['나들이'] || 0);
                                                            totalGrave += (s.typeCounts['성묘지원'] || 0);
                                                            totalEtc += (s.typeCounts['기타'] || 0);

                                                            return (
                                                                <tr key={i} className="border-b border-slate-50 hover:bg-slate-50 transition">
                                                                    <td className="pl-4 py-2 font-extrabold sticky left-0 bg-white z-10 border-r border-slate-100">{s.nm}</td>
                                                                    <td className={`text-center ${s.c1 > 0 ? 'text-slate-700' : 'text-slate-300'}`}>{s.c1 > 0 ? s.c1 : '-'}</td>
                                                                    <td className={`text-center ${s.c2 > 0 ? 'text-blue-500' : 'text-slate-300'}`}>{s.c2 > 0 ? s.c2 : '-'}</td>
                                                                    <td className={`text-center ${s.c3 > 0 ? 'text-orange-500' : 'text-slate-300'}`}>{s.c3 > 0 ? s.c3 : '-'}</td>
                                                                    <td className={`text-center border-l border-slate-100 ${s.typeCounts['공공예약'] > 0 ? 'text-slate-700' : 'text-slate-300'}`}>{s.typeCounts['공공예약'] || '-'}</td>
                                                                    <td className={`text-center ${s.typeCounts['시티투어'] > 0 ? 'text-blue-600' : 'text-slate-300'}`}>{s.typeCounts['시티투어'] || '-'}</td>
                                                                    <td className={`text-center ${s.typeCounts['나들이'] > 0 ? 'text-emerald-500' : 'text-slate-300'}`}>{s.typeCounts['나들이'] || '-'}</td>
                                                                    <td className={`text-center ${s.typeCounts['성묘지원'] > 0 ? 'text-indigo-500' : 'text-slate-300'}`}>{s.typeCounts['성묘지원'] || '-'}</td>
                                                                    <td className={`text-center ${s.typeCounts['기타'] > 0 ? 'text-purple-500' : 'text-slate-300'}`}>{s.typeCounts['기타'] || '-'}</td>
                                                                    {s.months.map((d, m) => { 
                                                                        const val = yearlyViewType === 'money' ? d.m : d.h; 
                                                                        return (<td key={m} className={`text-right px-2 ${m===0 ? 'border-l border-slate-100' : ''} ${val === 0 ? 'text-slate-200' : 'text-slate-700'}`}>{val > 0 ? (yearlyViewType === 'money' ? val.toLocaleString() : val.toFixed(1)) : '-'}</td>); 
                                                                    })}
                                                                    <td className="text-right font-black pr-4 bg-blue-50/30 text-blue-700 sticky right-0 border-l border-slate-100">{yearlyViewType === 'money' ? rowTotal.toLocaleString() : rowTotal.toFixed(1)}</td>
                                                                </tr>
                                                            );
                                                        });
                                                        rows.push(
                                                            <tr key="total" className="bg-slate-100 font-black border-t-2 border-slate-200">
                                                                <td className="pl-4 py-3 sticky left-0 bg-slate-100 z-10 border-r border-slate-200 text-slate-600">연간 합계</td>
                                                                <td className="text-center text-slate-700">{totalC1}</td>
                                                                <td className="text-center text-blue-600">{totalC2}</td>
                                                                <td className="text-center text-orange-600">{totalC3}</td>
                                                                <td className="text-center text-slate-700 border-l border-slate-200">{totalPub}</td>
                                                                <td className="text-center text-blue-600">{totalCity}</td>
                                                                <td className="text-center text-emerald-600">{totalPicnic}</td>
                                                                <td className="text-center text-indigo-600">{totalGrave}</td>
                                                                <td className="text-center text-purple-600">{totalEtc}</td>
                                                                {monthlyTotals.map((val, m) => (<td key={m} className={`text-right px-2 text-slate-700 ${m===0 ? 'border-l border-slate-200' : ''}`}>{yearlyViewType === 'money' ? val.toLocaleString() : val.toFixed(1)}</td>))}
                                                                <td className="text-right pr-4 bg-blue-100 text-blue-800 sticky right-0 border-l border-slate-300">{yearlyViewType === 'money' ? grandTotal.toLocaleString() : grandTotal.toFixed(1)}</td>
                                                            </tr>
                                                        );
                                                        return rows;
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>